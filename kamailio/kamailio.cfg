#!KAMAILIO

####### Minimal Kamailio Config for Testing #######

# ----------------- Modules to Load -----------------

loadmodule "sl.so"
loadmodule "tm.so"
loadmodule "tmx.so"
loadmodule "rr.so"
loadmodule "maxfwd.so"
loadmodule "sanity.so"
loadmodule "siputils.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "textops.so"
loadmodule "pv.so"
loadmodule "xlog.so"

# ----------------- Module Parameters -----------------

modparam("rr", "enable_full_lr", 1)
modparam("tm", "failure_reply_mode", 3)
modparam("registrar", "method_filtering", 1)
modparam("usrloc", "db_mode", 0)

# ----------------- Network Interfaces -----------------

listen=udp:0.0.0.0:5060 advertise=udp:3.85.251.30:5060

# ----------------- Main Routing Logic -----------------

request_route {

    xlog("L_INFO --- New Request: $rm from $si:$sp ---\n");

    # Drop if max forwards exceeded
    if (!mf_process_maxfwd(10)) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # Basic sanity checks
    if (!sanity_check("1761", "7")) {
        xlog("Malformed SIP message\n");
        exit;
    }

    # Handle registration
    if (is_method("REGISTER")) {
        route(REGISTRAR);
        exit;
    }

    # Relay SIP traffic
    if (is_method("INVITE|BYE|ACK|CANCEL|OPTIONS|INFO|UPDATE|SUBSCRIBE|NOTIFY")) {
        route(RELAY);
        exit;
    }

    # Everything else blocked
    sl_send_reply("405", "Method Not Allowed");
    exit;
}

# ----------------- Registrar Handling -----------------

route[REGISTRAR] {
    if (!save("location")) {
        sl_reply_error();
    }
    exit;
}

# ----------------- Relay Handling -----------------

route[RELAY] {
    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}
