#!KAMAILIO
mpath="/usr/lib/x86_64-linux-gnu/kamailio/modules/"

####### Minimal Kamailio Config for Testing #######

# ----------------- Modules to Load -----------------

loadmodule "sl.so"
loadmodule "tm.so"
loadmodule "tmx.so"
loadmodule "rr.so"
loadmodule "maxfwd.so"
loadmodule "sanity.so"
loadmodule "siputils.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "textops.so"
loadmodule "pv.so"
loadmodule "xlog.so"
loadmodule "permissions.so"
loadmodule "rtpproxy.so"
loadmodule "nathelper.so"

# ----------------- Module Parameters -----------------

modparam("rr", "enable_full_lr", 1)
modparam("tm", "failure_reply_mode", 3)
modparam("registrar", "method_filtering", 1)
#modparam("maxfwd", "max_limit", 70)
modparam("usrloc", "db_mode", 0)
modparam("tm", "failure_reply_mode", 3)
modparam("tm", "fr_timer", 10000)
modparam("tm", "fr_inv_timer", 120000)
modparam("tm", "restart_fr_on_each_reply", 1)
modparam("tm", "pass_provisional_replies", 1)
modparam("tm", "contacts_avp", "tm_contacts");
modparam("tm", "contact_flows_avp", "tm_contact_flows");

# ----------------- Network Interfaces -----------------

listen=udp:0.0.0.0:5060 advertise 3.85.251.30:5060

# ----------------- Main Routing Logic -----------------

request_route {


    xlog("L_INFO --- New Request: $rm from $si:$sp ---\n");

    $du = "sip:54.175.1.251:5060";

    # Basic sanity checks
    if (!sanity_check("1761", "7")) {
        xlog("Malformed SIP message\n");
        exit;
    }

    # 1. HANDLE ACK (CRITICAL FIX: Route directly to FS since loose_route fails)
    # if (is_method("ACK") || is_method("BYE")) {
    #     route(FS_ACK);
    #     exit;
    # }

    # 2. Handle in-dialog requests (BYE, UPDATE, etc.) using Route headers
    if (has_totag()) {
        # Check for Route header and set next hop ($du).
        if (loose_route()) {
            xlog("L_INFO --- In-dialog request handled by loose_route() ---");
            route(RELAY);
        } else {
            # This handles cases where BYE/ACK should have had a Route header but failed.
            sl_send_reply("404", "Dialog Route Not Found");
        }
        #testing loose_route() working
        if (is_method("ACK") || is_method("BYE")) {
            xlog("L_INFO --- In-dialog request not handled by loose_route() , hacky fix to directly route to FS---");
            route(FS_ACK);
            exit;
        }
        exit;
    }

    # Handle registration
    if (is_method("REGISTER")) {
        route(REGISTRAR);
        exit;
    }
    
    # Route INVITE to FS
    if (is_method("INVITE")) {
        record_route();
        route(FS);
        exit;
    }

    # Relay OPTION/INFO/Other stateless messages
    if (is_method("OPTIONS|INFO|UPDATE|SUBSCRIBE|NOTIFY")) {
        route(RELAY);
        exit;
    }

    # Everything else blocked
    sl_send_reply("405", "Method Not Allowed");
    exit;
}

# ----------------- Registrar Handling -----------------

route[REGISTRAR] {
    if (!save("location")) {
        sl_reply_error();
    }
    exit;
}

# ----------------- Relay Handling (Generic Forwarding for BYE/OPTIONS) -----------------

route[RELAY] {
    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}

# ----------------- FS ACK Forwarding (STATLESS HOP) -----------------
route[FS_ACK] {
    # Set target FS IP manually for stateless ACK
    $du = "sip:54.175.1.251:5060";
    
    # Forward the ACK to FreeSWITCH (t_relay uses $du as destination)
    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}

# ----------------- FS Relay (INVITE processing) -----------------
route[FS] {
    # NAT fixes are essential on the INVITE going to FS
    if (nat_uac_test(6)) {
        fix_nated_contact();
    }

    # Only fix SDP if message has body (INVITE has a body)
    if (has_body() && nat_uac_test(6)) {
        fix_nated_sdp("10");
    }

    # IMPORTANT: Ensure the advertised address in the Via/Record-Route is correct for replies
    # If Kamailio's public IP is 3.85.251.30
    $avp(pub_ip) = "3.85.251.30";
    # Tell Kamailio to use this IP in the Record-Route header toward FS
    nat_uac_set_advertised_address($avp(pub_ip), "5060");

    # Set target FS IP and port
    $du = "sip:54.175.1.251:5060";

    # t_relay handles the INVITE transaction statefully
    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}

# ----------------- ON REPLY ROUTING LOGIC (For 200 OK back to Caller) -----------------
onreply_route {
    xlog("L_INFO --- onreply_route ---\n");

    # CRITICAL: Fixes the 200 OK for the NATed client (the Caller)
    if (nat_uac_test(6)) {
        xlog("L_INFO --- onreply_route :: nat_uac_test(6) ---\n");
        # Fixes the Via and Contact headers in the response
        fix_nated_contact(); 
    }
}
